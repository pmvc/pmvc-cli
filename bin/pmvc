#!/usr/bin/env php
<?php
# debug
ini_set("error_reporting", E_ALL);
ini_set("display_errors", true);
ini_set("display_startup_errors", true);
$cli = new PmvcGlobalCli();
if ($cli->findAutoload()) {
    $cli->init();
}

class PmvcGlobalCli
{
    private $dir;
    private $dotenv;

    public function findAutoload()
    {
        $dir = realpath('./');
        $file = $dir.'/vendor/autoload.php';
        if (!is_file($file)) {
            $dirs = explode('/',$dir);
            while(!is_file($file)&&count($dirs)){
                array_pop($dirs);
                $dir = join('/',$dirs);
                $file = $dir.'/vendor/autoload.php';
            }
        }
        if (is_file($file)) {
            include($file);
            $this->dir = $dir;
            return true;
        } else {
            echo 'Can\'t find autoload file'."\n";
            return false;
        }
    }

    public function dump($s)
    {
        $cmd = \PMVC\plug('cli');
        $cmd->dump($s);
    }

    public function init()
    {
        PMVC\Load::plug();
        PMVC\addPlugInFolder(__DIR__.'/../../../pmvc-plugin');
        $dir = \PMVC\realpath($this->dir);
        $dotenv = $dir.'/.env';
        $this->dotenv = $dotenv;
        $controller = \PMVC\plug('controller');
        $controller[_ROUTER] = 'cli';

        // plugins 
        $plugins = [
            'dispatcher'=>null,
            'cli'=>null,
            'error'=>null,
            'debug'=>['output'=>'debug_cli'],
        ];
        if (\PMVC\realpath($dotenv)) {
            $plugins['dotenv'] = ['envFile'=>$dotenv];
        }
        \PMVC\initPlugIn($plugins);
        $verifyPlugin = true;
        array_walk($plugins, function($item, $key) use (&$verifyPlugin){
            if (!\PMVC\exists($key,'plugin')) {
                $verifyPlugin = false;
                echo 'Plugin ['.$key.'] not installed.'."\n";
            }
        });
        if (!$verifyPlugin) {
            return false;
        }
        $parent = \PMVC\getOption(_RUN_PARENT);
        $parent = str_replace(['..','.'],[$dir,$dir],$parent);
        $input = $this->parseParams();
        if ($input->trace) {
            \PMVC\plug('debug_cli')['level']='trace';
        }
        $controller->slient([
           _VIEW_ENGINE=>$input->view,
           _RUN_PARENT=>$parent
        ]);
        $cliEnv = $dir.'/.env.cli';
        if (\PMVC\realpath($cliEnv)) {
            \PMVC\plug('dotenv')->toPMVC($cliEnv);
        }
        $this->welcome();
        if ($controller->plugApp([], [], $input->index)){
            $controller();
        }
    }

    public function parseParams()
    {
        $cmd = \PMVC\plug('cli');
        $params = (object)$cmd->getopt();
        $default = (object)[
            'index'=>'index_cli',
            'view'=>'cli',
            'trace'=>false
        ];
        if (isset($params->i)) {
            $default->index = $params->i;
        }
        if (isset($params->v)) {
            $default->view = $params->v;
        }
        if (isset($params->t)) {
            $default->trace = true;
        }
        return $default;
    }

    public function welcome()
    {
        $this->dump('Workplace: '.$this->dir);
        $this->dump('DotEnv: '.$this->dotenv);
    }
}

